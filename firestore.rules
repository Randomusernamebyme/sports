rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 檢查用戶是否已登入
    function isAuthenticated() {
      return request.auth != null;
    }

    // 檢查是否為文檔擁有者
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // 用戶文檔
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // 遊戲進度
    match /gameProgress/{progressId} {
      allow read, write: if isAuthenticated() && (
        // 允許用戶讀寫自己的遊戲進度
        progressId == request.auth.uid ||
        // 或者是新建遊戲進度
        (request.method == 'create' && progressId == request.auth.uid)
      );
    }

    // 遊戲會話
    match /gameSessions/{sessionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // 遊戲任務
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow write: if false; // 只允許管理員寫入
    }
    
    // 遊戲事件
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow write: if false; // 只允許管理員寫入
    }

    // 用戶位置
    match /locations/{locationId} {
      allow read, write: if isAuthenticated() && locationId == request.auth.uid;
    }
    
    // 默認拒絕所有其他訪問
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 